<!DOCTYPE html>
<html>
<head>
    <title>Password Manager</title>
    <style>
        /* 添加自定义样式 */
    </style>
</head>
<body>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="masterPassword" placeholder="Master Password">
    <button onclick="login()">Login</button>

    <div id="vault" style="display:none;">
        <input type="text" id="entryTitle" placeholder="Title">
        <input type="password" id="entryPassword" placeholder="Password">
        <button onclick="addEntry()">Add Entry</button>
        <div id="entries"></div>
    </div>

    <script>
        // 包含加密和 API 调用的 JavaScript 代码
        let userId = '';
        let masterPassword = '';

        async function login() {
            const username = document.getElementById('username').value;
            masterPassword = document.getElementById('masterPassword').value;
            const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(username + masterPassword));
            userId = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            document.getElementById('vault').style.display = 'block';
            loadEntries();
        }

        async function encrypt(data) {
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                new TextEncoder().encode(masterPassword),
                { name: 'PBKDF2' },
                false,
                ['deriveKey']
            );
            const key = await crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv },
                key,
                new TextEncoder().encode(data)
            );
            return {
                encrypted: Array.from(new Uint8Array(encrypted)),
                salt: Array.from(salt),
                iv: Array.from(iv)
            };
        }

        async function decrypt(encryptedData) {
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                new TextEncoder().encode(masterPassword),
                { name: 'PBKDF2' },
                false,
                ['deriveKey']
            );
            const key = await crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt: new Uint8Array(encryptedData.salt), iterations: 100000, hash: 'SHA-256' },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['decrypt']
            );
            const decrypted = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: new Uint8Array(encryptedData.iv) },
                key,
                new Uint8Array(encryptedData.encrypted)
            );
            return new TextDecoder().decode(decrypted);
        }

        async function loadEntries() {
            const response = await fetch('https://ps.qingju7.workers.dev/vault', {
                headers: { 'X-User-ID': userId }
            });
            const entries = await response.json();
            const entriesDiv = document.getElementById('entries');
            entriesDiv.innerHTML = '';
            for (const entry of entries) {
                const decryptedData = JSON.parse(await decrypt(JSON.parse(entry.data)));
                entriesDiv.innerHTML += `
                    <div class="entry">
                        <h3>${decryptedData.title}</h3>
                        <button onclick="deleteEntry('${entry.id}')">Delete</button>
                    </div>
                `;
            }
        }

        async function addEntry() {
            const title = document.getElementById('entryTitle').value;
            const password = document.getElementById('entryPassword').value;
            const encrypted = await encrypt(JSON.stringify({ title, password }));
            await fetch('https://ps.qingju7.workers.dev/vault', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': userId
                },
                body: JSON.stringify({ encryptedData: JSON.stringify(encrypted) })
            });
            loadEntries();
        }

        async function deleteEntry(entryId) {
            await fetch(`https://ps.qingju7.workers.dev/vault/${entryId}`, {
                method: 'DELETE',
                headers: { 'X-User-ID': userId }
            });
            loadEntries();
        }
    </script>
</body>
</html>